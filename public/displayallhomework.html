<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <title>Controle Homework</title>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Controle Homework</a>
        </div>
    </nav>

    <div class="container">
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Topic</th>
                        <th>Teacher Name</th>
                        <th>Class Name</th>
                        <th>Subject Name</th>
                        <th>Comment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="homeworkTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Homework</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateForm">
                        <input type="hidden" id="updateId">
                        <div class="mb-3">
                            <label class="form-label">Topic</label>
                            <input type="text" class="form-control" id="updateTopic" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teacher Name</label>
                            <input type="text" class="form-control" id="updateTeacherName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Class Name</label>
                            <input type="text" class="form-control" id="updateClassName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject Name</label>
                            <input type="text" class="form-control" id="updateSubjectName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comment</label>
                            <textarea class="form-control" id="updateComment" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        async function loadData() {
            try {
                const teacherRes = await fetch('http://localhost:4000/teacherdata');
                const teacherData = await teacherRes.json();

                const homeworkRes = await fetch("http://localhost:4000/homeworkget");
                const homeworkData = await homeworkRes.json();

                const tableBody = document.getElementById("homeworkTableBody");
                tableBody.innerHTML = "";

                homeworkData.forEach(element => {
                    if (element.id === teacherData.id) {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${element.topic}</td>
                            <td>${element.teacherName}</td>
                            <td>${element.className}</td>
                            <td>${element.subjectName}</td>
                            <td>${element.comment}</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm me-1" onclick="openUpdateModal('${element._id}', '${element.topic}', '${element.teacherName}', '${element.className}', '${element.subjectName}', '${element.comment}')">Update</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteHomework('${element._id}')">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    }
                });

            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function openUpdateModal(id, topic, teacherName, className, subjectName, comment) {
            document.getElementById("updateId").value = id;
            document.getElementById("updateTopic").value = topic;
            document.getElementById("updateTeacherName").value = teacherName;
            document.getElementById("updateClassName").value = className;
            document.getElementById("updateSubjectName").value = subjectName;
            document.getElementById("updateComment").value = comment;

            const modal = new bootstrap.Modal(document.getElementById("updateModal"));
            modal.show();
        }

        document.getElementById("updateForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const id = document.getElementById("updateId").value;
            const updatedData = {
                topic: document.getElementById("updateTopic").value,
                teacherName: document.getElementById("updateTeacherName").value,
                className: document.getElementById("updateClassName").value,
                subjectName: document.getElementById("updateSubjectName").value,
                comment: document.getElementById("updateComment").value
            };

            try {
                const res = await fetch(`http://localhost:4000/homeworkupdate/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(updatedData)
                });

                const data = await res.json();
                alert(data.message);
                loadData();
                bootstrap.Modal.getInstance(document.getElementById("updateModal")).hide();
            } catch (error) {
                console.error("Update error:", error);
            }
        });

        async function deleteHomework(id) {
            if (confirm("Are you sure you want to delete this homework?")) {
                try {
                    const res = await fetch(`http://localhost:4000/homeworkdelete/${id}`, {
                        method: "DELETE"
                    });
                    const result = await res.json();
                    if (res.ok) {
                        alert(result.message || "Homework deleted!");
                        loadData();
                    } else {
                        alert(result.message || "Failed to delete homework");
                    }
                } catch (err) {
                    console.error("Delete error:", err);
                }
            }
        }

        loadData();
    </script>
</body>
</html>
